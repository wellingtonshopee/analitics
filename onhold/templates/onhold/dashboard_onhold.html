{% extends "core/base.html" %}

{% block titulo %}Visualização ONHold{% endblock %}

{% block custom_styles %}
<style>
    /* Mantendo apenas os estilos de visualização de métricas */
    .card-title {
        font-size: 1.1rem;
    }
    .display-4 {
        font-weight: 700;
        color: #007bff; /* Cor primária do Bootstrap */
    }
    /* Estilo para alinhar melhor o texto de peso */
    .h2-metric {
        font-size: 1.75rem; /* Menor que h2 padrão para caber na linha */
        font-weight: 700;
        margin-bottom: 0 !important;
    }
</style>
{% endblock %}

{% block conteudo %}

<div class="container-fluid py-4">
    <h1 class="mb-4">Analise Final On Hold</h1>

    <div class="card shadow mb-4">
        <div class="card-body">
            <form method="get" class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label for="data_inicio" class="form-label">De:</label>
                    <input type="date" class="form-control" id="data_inicio" name="data_inicio" value="{{ data_inicio_value }}" required>
                </div>
                <div class="col-md-3">
                    <label for="data_fim" class="form-label">Até:</label>
                    <input type="date" class="form-control" id="data_fim" name="data_fim" value="{{ data_fim_value }}" required>
                </div>
                <div class="col-md-3">
                    <button type="submit" class="btn btn-success w-100">
                        <i class="fas fa-filter me-1"></i> Aplicar Filtro
                    </button>
                </div>
            </form>
            <p class="mt-3 text-muted">Exibindo dados de **{{ data_inicio_value }}** a **{{ data_fim_value }}**.</p>
        </div>
    </div>

    <div class="row mb-4">
        
        <div class="col-md-6 col-lg-3 mb-4">
            <div class="card text-white bg-primary shadow h-100">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-9">
                            <div class="text-uppercase mb-1" style="font-size: 0.8rem;">
                                Total de Registros Analisados
                            </div>
                            <div class="h2 mb-0">{{ total_onhold_periodo }}</div>
                        </div>
                        <div class="col-3 text-end">
                            <i class="fas fa-boxes fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6 col-lg-3 mb-4">
            <div class="card text-white bg-info shadow h-100">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-9">
                            <div class="text-uppercase mb-1" style="font-size: 0.8rem;">
                                On Hold Registrados
                            </div>
                            <div class="h2 mb-0">{{ rastreios_unicos }}</div>
                        </div>
                        <div class="col-3 text-end">
                            <i class="fas fa-barcode fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6 col-lg-3 mb-4">
            <div class="card text-white bg-danger shadow h-100">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-9">
                            <div class="text-uppercase mb-1" style="font-size: 0.8rem;">
                                Pacotes a Devolver (OnHold)
                            </div>
                             <a href="{% url 'consulta_por_motivo' motivo='OnHold' %}?data_inicio={{ data_inicio_value }}&data_fim={{ data_fim_value }}" class="h2 mb-0 text-white stretched-link text-decoration-none">
                                {{ total_a_devolver }}
                            </a>
                        </div>
                        <div class="col-3 text-end">
                            <i class="fas fa-exclamation-triangle fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6 col-lg-3 mb-4">
            <div class="card text-white bg-success shadow h-100">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-9">
                            <div class="text-uppercase mb-1" style="font-size: 0.8rem;">
                                Pacotes On Hold Devolvidos
                            </div>
                            <a href="{% url 'consulta_por_motivo' motivo='LMHub_Received' %}?data_inicio={{ data_inicio_value }}&data_fim={{ data_fim_value }}" class="h2 mb-0 text-white stretched-link text-decoration-none">
                                {{ total_devolvidos }}
                            </a>
                        </div>
                        <div class="col-3 text-end">
                            <i class="fas fa-check-circle fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div> 
    
    <div class="row mb-4">
        
        <div class="col-md-6 col-lg-3 mb-4">
            <div class="card text-white bg-dark shadow h-100">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-9">
                            <div class="text-uppercase mb-1" style="font-size: 0.8rem;">
                                Volumosos (Insufficient Vehicle Capacity)
                            </div>
                            <a href="{% url 'detalhe_volumosos' %}?data_inicio={{ data_inicio_value }}&data_fim={{ data_fim_value }}" class="h2 mb-0 text-white stretched-link text-decoration-none">
                                {{ total_volumosos }}
                            </a>
                        </div>
                        <div class="col-3 text-end">
                            <i class="fas fa-truck-loading fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6 col-lg-3 mb-4">
            <div class="card text-white bg-warning shadow h-100">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-9">
                            <div class="text-uppercase mb-1" style="font-size: 0.8rem;">
                                Perdidos (Parcel Lost / OnHold - P.N.R)
                            </div>
                             <a href="{% url 'consulta_por_motivo' motivo='Parcel lost' %}?data_inicio={{ data_inicio_value }}&data_fim={{ data_fim_value }}" class="h2 mb-0 text-white stretched-link text-decoration-none">
                                {{ total_perdidos }}
                            </a>
                        </div>
                        <div class="col-3 text-end">
                            <i class="fas fa-box-open fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6 col-lg-3 mb-4">
            <div class="card text-white bg-secondary shadow h-100">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-9">
                            <div class="text-uppercase mb-1" style="font-size: 0.8rem;">
                                Atribuição Errada (Wrongly assigned)
                            </div>
                            <a href="{% url 'consulta_por_motivo' motivo='Wrongly assigned' %}?data_inicio={{ data_inicio_value }}&data_fim={{ data_fim_value }}" class="h2 mb-0 text-white stretched-link text-decoration-none">
                                {{ total_wrongly_assigned }}
                            </a>
                        </div>
                        <div class="col-3 text-end">
                            <i class="fas fa-crosshairs fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6 col-lg-3 mb-4">
            <div class="card text-dark bg-light shadow h-100">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-9">
                            <div class="text-uppercase mb-1 text-muted" style="font-size: 0.8rem;">
                                Média de Peso (Kg)
                            </div>
                            <div class="h2-metric mb-0">{{ media_peso }} <small class="text-muted" style="font-size: 0.6em;">Kg</small></div>
                        </div>
                        <div class="col-3 text-end">
                            <i class="fas fa-balance-scale fa-2x text-muted"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    </div>
    <div class="row">
        <div class="col-md-12 col-lg-6 mb-4">
            <div class="card shadow h-100">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    {# TÍTULO E TOTAL #}
                    <h5 class="card-title mb-0">
                        Registros OnHold por Motorista 
                        {% if total_a_devolver > 0 %}
                            <span class="text-muted small">({{ total_a_devolver }} no total)</span>
                        {% endif %}
                    </h5>
                    
                    {# BOTÃO DE EXPORTAÇÃO CSV #}
                    <a href="{% url 'exportar_onhold_motorista_csv' %}?data_inicio={{ data_inicio_value }}&data_fim={{ data_fim_value }}" 
                        class="btn btn-sm btn-outline-danger" 
                        title="Exportar para CSV">
                        <i class="fas fa-file-csv me-1"></i> Exportar CSV
                    </a>
                </div>
                <div class="card-body p-0" style="max-height: 300px; overflow-y: auto;">
                    <div class="list-group list-group-flush">
                        {% for item in registros_por_motorista %}
                            
                            {# CORREÇÃO APLICADA AQUI: Substituímos o <a> por <div> mantendo a classe list-group-item #}
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                {{ item.driver_name|default:"Motorista Não Informado" }}
                                <span class="badge bg-danger rounded-pill">{{ item.total }}</span>
                            </div>
                        {% empty %}
                            <div class="list-group-item">Nenhum registro OnHold encontrado para o período.</div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-12 col-lg-6 mb-4">
            <div class="card shadow h-100">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">Motivos de Retenção (Clique para detalhar)</h5>
                </div>
                <div class="card-body p-0" style="max-height: 300px; overflow-y: auto;">
                    <div class="list-group list-group-flush">
                        {% for item in motivos_contagem %}
                            <a href="{% url 'consulta_por_motivo' motivo=item.onhold_reason %}" 
                                class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                                
                                {{ item.onhold_reason|default:"Motivo Não Identificado" }}
                                <span class="badge bg-danger rounded-pill">{{ item.total }}</span>
                            </a>
                        {% empty %}
                            <div class="list-group-item">Nenhum dado de motivo para o período.</div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block custom_scripts %}
{# REMOVIDAS TODAS AS TAGS DE JSON_SCRIPT E O CÓDIGO JAVASCRIPT DOS GRÁFICOS #}
{% endblock %}