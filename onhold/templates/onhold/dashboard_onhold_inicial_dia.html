{% extends "core/base.html" %}
{% load static %}
{% load humanize %} 

{% block titulo %}Dashboard ONHold Inicial Dia{% endblock %}

{% block custom_styles %}
<style>
    /* MODIFICADO: Aumenta a fonte do número para ser maior que o título */
    .h2-metric {
        font-size: 3rem; 
        font-weight: 700;
        margin-bottom: 0 !important;
    }
    .list-group-item:hover {
        background-color: #f8f9fa; 
    }
</style>
{% endblock %}

{% block conteudo %}
<div class="container-fluid py-4">
    <h1 class="mb-4">Dashboard OnHold - Prévia de Devoluções Diarias</h1>

    {# 1. FORMULÁRIO DE FILTRO DE DATA #}
    <div class="card shadow mb-4">
        <div class="card-body">
            <form method="get" class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label for="data_inicio" class="form-label fw-bold">Data Início (Data de Envio)</label>
                    <input type="date" 
                            name="data_inicio" 
                            id="data_inicio" 
                            class="form-control" 
                            value="{{ data_inicio_str|default:'' }}">
                </div>
                <div class="col-md-3">
                    <label for="data_fim" class="form-label fw-bold">Data Fim (Data de Envio)</label>
                    <input type="date" 
                            name="data_fim" 
                            id="data_fim" 
                            class="form-control" 
                            value="{{ data_fim_str|default:'' }}">
                </div>
                <div class="col-md-3">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-filter me-1"></i> Aplicar Filtro
                    </button>
                </div>
                <div class="col-md-3">
                    <a href="{% url 'dashboard_onhold_inicial_dia' %}" class="btn btn-outline-secondary w-100">
                        <i class="fas fa-redo me-1"></i> Limpar Filtro
                    </a>
                </div>
            </form>
        </div>
    </div>
    
    <p class="lead">
        {% if data_inicio_str and data_fim_str %}
            Dados Filtrados: **{{ total_registros|intcomma }}** Registros | Período: **{{ data_inicio_str|date:"d/m/Y" }}** a **{{ data_fim_str|date:"d/m/Y" }}**
        {% else %}
            Dados Atuais: **{{ total_registros|intcomma }}** Registros (Visão Geral)
        {% endif %}
    </p>

    {# 2. KPI ÚNICO: TOTAL DE REGISTROS FILTRADO #}
    <div class="row">
        <div class="col-md-12 col-lg-4 mb-4">
            {# bg-light para fundo cinza claro. text-dark para o texto padrão no card #}
            <div class="card shadow h-100 bg-light text-dark">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-auto">
                            {# Ícone em cinza escuro para contraste no fundo claro #}
                            <i class="fas fa-check-double fa-2x text-secondary"></i>
                        </div>
                        <div class="col">
                            {# Título em preto #}
                            <div class="text-xs fw-bold text-uppercase mb-1 text-dark">Total de Devolução</div>
                            {# Número em tamanho MAIOR (3rem) e vermelho em negrito #}
                            <div class="h2-metric text-danger">{{ total_registros|intcomma }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# 3. TABELAS DETALHADAS #}
    <div class="row">
        
        {# Motoristas e Registros #}
        <div class="col-md-12 col-lg-6 mb-4">
            <div class="card shadow h-100">
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0 text-white">Motoristas e Contagem de Registros (**Clique para Detalhar**)</h5>
                </div>
                <div class="card-body p-0" style="max-height: 400px; overflow-y: auto;">
                    <div class="list-group list-group-flush">
                        {% for item in motoristas_contagem %}
                            {% with driver_name=item.driver_name_clean|default:"(Motorista Não Informado)" %}
                                <a href="{% url 'detalhe_pacotes_inicial' %}?driver={{ driver_name|urlencode }}&data_inicio={{ data_inicio_str }}&data_fim={{ data_fim_str }}" 
                                    class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                                    {{ driver_name }}
                                    <span class="badge bg-success rounded-pill">{{ item.total|intcomma }}</span>
                                </a>
                            {% endwith %}
                        {% empty %}
                            <div class="list-group-item">Nenhum motorista encontrado no período.</div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        
        {# Motivos de Retenção #}
        <div class="col-md-12 col-lg-6 mb-4">
            <div class="card shadow h-100">
                <div class="card-header bg-danger text-white">
                    <h5 class="card-title mb-0 text-white">Motivos de Retenção (**Clique para Detalhar**)</h5>
                </div>
                <div class="card-body p-0" style="max-height: 400px; overflow-y: auto;">
                    <div class="list-group list-group-flush">
                        {% for item in motivos_contagem %}
                            {% with reason=item.onhold_reason|default:"(Motivo Não Informado)" %}
                                <a href="{% url 'detalhe_pacotes_inicial' %}?reason={{ reason|urlencode }}&data_inicio={{ data_inicio_str }}&data_fim={{ data_fim_str }}" 
                                    class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                                    {{ reason }}
                                    <span class="badge bg-danger rounded-pill">{{ item.total|intcomma }}</span>
                                </a>
                            {% endwith %}
                        {% empty %}
                            <div class="list-group-item">Nenhum motivo de retenção encontrado no período.</div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block custom_scripts %}
{% endblock %}