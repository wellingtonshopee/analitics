{% extends "core/base.html" %}
{% load static %}
{% load humanize %}

{% block titulo %}{{ titulo }}{% endblock %}

{% block conteudo %}
<div class="container-fluid py-4">

    <style>
        /* Sombra principal para cards */
        .card.shadow-lg, .card.custom-shadow {
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.14) !important;
            transition: transform 0.18s ease, box-shadow 0.18s ease;
            border-radius: 0.5rem;
        }

        /* Hover: levanta o card */
        /* Aplicado à tag <a> para que o efeito funcione no link */
        .text-decoration-none:hover .card {
            transform: translateY(-6px);
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.20) !important;
        }

        /* Sombra mais sutil para alerts */
        .alert.shadow {
            box-shadow: 0 4px 14px rgba(0, 0, 0, 0.06);
        }

        /* Cabeçalhos dos cards com cantos arredondados (para compatibilidade com bordas personalizadas) */
        .card .card-header {
            border-top-left-radius: 0.5rem;
            border-top-right-radius: 0.5rem;
        }

        /* Ajuste mínimo de altura para consistência visual dos KPIs */
        .h-100 {
            min-height: 120px;
        }

        /* Pequeno ajuste responsivo (opcional) */
        @media (max-width: 576px) {
            .h-100 { min-height: 100px; }
        }
    </style>
    <h1 class="mb-4 fw-bold text-dark">{{ titulo }}</h1>

    <div class="card shadow-lg mb-5 border-0">
        <div class="card-header bg-secondary text-white d-flex align-items-center">
            <i class="fas fa-filter me-2"></i>
            <h5 class="mb-0">Filtros de Análise</h5>
        </div>
        <div class="card-body">
            <form method="GET" class="row g-3">

                <div class="col-md-3">
                    <label for="{{ form.data_inicio.id_for_label }}" class="form-label fw-semibold">{{ form.data_inicio.label }}</label>
                    {{ form.data_inicio }}
                </div>

                <div class="col-md-3">
                    <label for="{{ form.data_fim.id_for_label }}" class="form-label fw-semibold">{{ form.data_fim.label }}</label>
                    {{ form.data_fim }}
                </div>

                <div class="col-md-3">
                    <label for="{{ form.status.id_for_label }}" class="form-label fw-semibold">{{ form.status.label }}</label>
                    {{ form.status }}
                </div>

                <div class="col-md-3">
                    <label for="{{ form.city.id_for_label }}" class="form-label fw-semibold">{{ form.city.label }}</label>
                    {{ form.city }}
                </div>

                <div class="col-md-3">
                    <label for="{{ form.destination_hub.id_for_label }}" class="form-label fw-semibold">{{ form.destination_hub.label }}</label>
                    {{ form.destination_hub }}
                </div>

                <div class="col-12 mt-4">
                    <button type="submit" class="btn btn-primary me-2">
                        <i class="fas fa-search me-2"></i> Aplicar Filtros
                    </button>
                    <a href="{% url 'dashboard_pool' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-redo-alt me-2"></i> Limpar Filtros
                    </a>
                </div>
            </form>
        </div>
    </div>
    {% if total_registros > 0 %}

    <h2 class="mb-4 text-dark fw-bold">Análise de Indicadores (KPIs)</h2>
    <div class="row gy-4">

        <div class="col-lg-3 col-md-6">
            <div class="card shadow-lg border-start border-primary border-4 h-100">
                <div class="card-body">
                    <h6 class="text-primary text-uppercase fw-bold">Total de Registros (Base)</h6>
                    <p class="fs-4 fw-bold mb-0">{{ kpis.total_registros|intcomma }}</p>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6">
            <div class="card shadow-lg border-start border-warning border-4 h-100">
                <div class="card-body">
                    <h6 class="text-warning text-uppercase fw-bold">Status: LMHub_Received</h6>
                    <p class="fs-4 fw-bold mb-0">{{ kpis.status_received|intcomma }}</p>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6">
            <div class="card shadow-lg border-start border-danger border-4 h-100">
                <div class="card-body">
                    <h6 class="text-danger text-uppercase fw-bold">Status: A Processar / Exceção</h6>
                    <p class="fs-4 fw-bold mb-0">{{ kpis.status_outros|intcomma }}</p>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6">
            <div class="card shadow-lg border-start border-success border-4 h-100">
                <div class="card-body">
                    <h6 class="text-success text-uppercase fw-bold">Destination Hub: Muriaé</h6>
                    <p class="fs-4 fw-bold mb-0">{{ kpis.hub_muriae|intcomma }}</p>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6">
            <div class="card shadow-lg border-start border-info border-4 h-100">
                <div class="card-body">
                    <h6 class="text-info text-uppercase fw-bold">Destination Hub: Outros</h6>
                    <p class="fs-4 fw-bold mb-0">{{ kpis.hub_outros|intcomma }}</p>
                </div>
            </div>
        </div>
    </div>

    <h2 class="mb-4 mt-5 text-dark fw-bold">Total de Pacotes para Roteirizar</h2>
    <div class="row gy-4">
        {% for status_item in kpis.total_por_status_dinamico %}
        <div class="col-lg-3 col-md-6">
            {# Link do KPI ajustado para persistir os filtros #}
            <a href="{% url 'pool_detail_list' status_slug=status_item.status|slugify %}?{{ filter_query_string }}" class="text-decoration-none d-block h-100">
                <div class="card custom-shadow border-start border-secondary border-4 h-100">
                    <div class="card-body">
                        <h6 class="text-secondary text-uppercase fw-bold">{{ status_item.status }}</h6>
                        <p class="fs-4 fw-bold mb-0">{{ status_item.count|intcomma }}</p>
                    </div>
                </div>
            </a>
        </div>
        {% endfor %}
    </div>

    <h2 class="mb-3 mt-4">Top Cidades por Volume (no filtro)</h2>
<div class="row">
    <div class="col-lg-6 mb-4">
        <div class="card shadow-lg">
            <div class="card-header bg-dark text-white">
                <h6 class="m-0 font-weight-bold">Contagem por Cidade</h6>
            </div>
            <div class="card-body">
                {% if kpis.total_por_cidade %}
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Cidade</th>
                            <th>Total de Registros</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in kpis.total_por_cidade %}
                        <tr>
                            <td>
                                {# Link da Cidade ajustado para persistir os filtros #}
                                <a href="{% url 'pool_detail_list_by_city' city_slug=item.city|slugify %}?{{ filter_query_string }}" class="fw-semibold text-primary text-decoration-none">
                                    {{ item.city|default:"(Não Informado)" }}
                                </a>
                            </td>
                            <td>{{ item.count|intcomma }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p class="text-muted">Nenhum dado de cidade encontrado com os filtros aplicados.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
    {% else %}
    <div class="alert alert-info mt-4 shadow">
        Nenhum registro de Collection Pool encontrado com os filtros aplicados.
        <a href="{% url 'upload_pool_csv' %}" class="alert-link">Clique aqui para carregar dados.</a>
    </div>
    {% endif %}

</div>
{% endblock %}